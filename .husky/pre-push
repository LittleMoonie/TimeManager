#!/usr/bin/env bash
# üß± Husky pre-push hook ‚Äî GoGoTime Monorepo
# Blocks pushes to or from protected branches unless ALLOW_PROTECTED_PUSH=1

[ -z "${BASH_VERSION:-}" ] && exec /usr/bin/env bash "$0" "$@"
set -Eeuo pipefail

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  helpers  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
red()  { printf "\033[31m%s\033[0m\n" "$*"; }
grn()  { printf "\033[32m%s\033[0m\n" "$*"; }
ylw()  { printf "\033[33m%s\033[0m\n" "$*"; }
blu()  { printf "\033[34m%s\033[0m\n" "$*"; }
abort(){ red "‚ùå $*"; exit 1; }
note() { blu "‚ÑπÔ∏è  $*"; }
ok()   { grn "‚úÖ $*"; }

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ  config  ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
PROTECTED=("origin/main" "origin/develop" "main" "develop")
BYPASS="${ALLOW_PROTECTED_PUSH:-0}"

echo ""
blu "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
blu "üîí  GoGoTime Push Protection"
blu "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
echo ""
note "Checking push target for protected branches..."

CURRENT_BRANCH="$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo HEAD)"
REMOTE="${1:-origin}"
# determine destination branch robustly
if [ -n "${2:-}" ]; then
  DEST="$2"
else
  # try to detect upstream branch (for plain `git push`)
  DEST="$(git rev-parse --abbrev-ref --symbolic-full-name @{u} 2>/dev/null || true)"
  # if that failed, read the remote‚Äôs HEAD ref as a last resort
  [ -z "$DEST" ] && DEST="$(git remote show "$REMOTE" 2>/dev/null | awk '/HEAD branch/ {print $NF}')"
fi


BLOCK=0

# 1Ô∏è‚É£  always block pushes *from* protected branches
      for BR in "${PROTECTED[@]}"; do
  if [[ "$CURRENT_BRANCH" == "$BR" ]]; then
    red "‚ùå Push blocked: you are on protected branch '$BR'"
    echo "   Please create a feature branch and open a PR."
    BLOCK=1
  fi
done

# 2Ô∏è‚É£  block pushes *to* protected branches (explicit arg or detected ref)
# Detect destination name whether it's "origin develop" or "origin/develop"
if [[ "$DEST" =~ ^(refs/heads/)?(main|develop)$ ]]; then
  red "‚ùå Push blocked: destination branch '${BASH_REMATCH[2]}' is protected"
  BLOCK=1
elif [[ "$DEST" =~ ^origin/(main|develop)$ ]]; then
  red "‚ùå Push blocked: destination branch '${BASH_REMATCH[1]}' is protected"
  BLOCK=1
fi

# 3Ô∏è‚É£  check stdin refs if Git sends them
while read -r LOCAL_REF LOCAL_SHA REMOTE_REF REMOTE_SHA; do
  [ -z "${REMOTE_REF:-}" ] && continue
  for BR in "${PROTECTED[@]}"; do
    if [[ "$REMOTE_REF" == "refs/heads/$BR" ]]; then
      red "‚ùå Push blocked: remote target '$BR' is protected"
      BLOCK=1
    fi
  done
done

# 4Ô∏è‚É£  final decision
if [[ "$BLOCK" -eq 1 ]]; then
  if [[ "$BYPASS" == "1" ]]; then
    ylw "‚ö†Ô∏è  Bypass enabled (ALLOW_PROTECTED_PUSH=1). Proceeding anyway."
    exit 0
  fi
  echo ""
  red "üõë Push cancelled ‚Äî protected branch detected."
  blu "   Use a Pull Request instead."
  echo ""
  exit 1
fi

ok "No protected branches targeted. Safe to push."
echo ""
exit 0
